# バス時刻案内 LINE Bot 要件定義書

## 1. プロジェクト概要

**サービス名**: バス時刻案内 LINE Bot  
**目的**: ユーザーが登録した駅・バス停間の時刻表を簡単に確認できるLINE Botを提供する  
**ステータス**: ✅ 要件確定

---

## 2. 主要機能

### 2.1 ユーザー登録機能
| 機能 | 説明 |
|------|------|
| 初回登録 | LINE友だち追加時に、行き・帰りのバス停を別々に登録 |
| 行き設定 | 出発地（自宅など）→ 目的地（会社など）を登録 |
| 帰り設定 | 出発地（会社：デフォルト）→ 目的地（自宅など）を登録 |
| 複数ルート | 複数のルートを登録可能（状況に応じて選択） |
| 設定変更 | 登録した駅・バス停をいつでも変更可能 |

### 2.2 時刻検索機能（クイックリプライ）
| 機能 | 説明 |
|------|------|
| 「行く」ボタン | 登録した行きルートの次のバス2本を表示 |
| 「帰る」ボタン | 登録した帰りルート（デフォルト：会社発）の次のバス2本を表示 |
| ルート選択 | 複数ルートがある場合は選択可能 |

### 2.3 自然言語検索機能
| 機能 | 説明 |
|------|------|
| 到着時刻指定 | 「〇〇時に会社に着きたい」→ 乗るべきバスを提案 |
| 出発時刻指定 | 「〇〇時に出発したい」→ 該当するバスを表示 |
| 柔軟な入力対応 | 様々な言い回しに対応 |

### 2.4 通知機能
| 機能 | 説明 |
|------|------|
| オンデマンド通知 | ユーザーが指定した時間に通知を受け取れる |
| 通知設定 | 「明日7時に通知して」などで設定可能 |
| 通知解除 | いつでも通知をキャンセル可能 |

### 2.5 リッチメニュー
| ボタン | 機能 |
|--------|------|
| 🚌 行く | 行きのバス時刻を表示 |
| 🏠 帰る | 帰りのバス時刻を表示 |
| ⏰ 通知設定 | 通知時間を設定 |
| ⚙️ 設定 | ルート登録・変更 |

---

## 3. ユーザーフロー

### 3.1 初回登録フロー
```
友だち追加
    ↓
ウェルカムメッセージ
    ↓
「【行き】の出発バス停を入力してください（例：自宅前）」
    ↓
ユーザー入力
    ↓
「【行き】の目的地を入力してください（例：〇〇駅）」
    ↓
ユーザー入力
    ↓
「【帰り】の出発地は会社でよろしいですか？」
  → はい：会社を設定
  → いいえ：別の場所を入力
    ↓
「【帰り】の目的地を入力してください」
    ↓
ユーザー入力
    ↓
「登録完了！」+ 使い方説明 + リッチメニュー表示
```

### 3.2 通常利用フロー
```
リッチメニュー or テキスト入力
    ↓
┌─────────────────────────────────────────┐
│ 「行く」 → 次のバス2本を表示            │
│ 「帰る」 → 帰りのバス2本を表示          │
│ 「9時に会社に着きたい」→ 提案表示      │
│ 「明日7時に通知して」→ 通知を予約      │
│ 「設定」 → ルート追加・変更             │
└─────────────────────────────────────────┘
```

### 3.3 複数ルート選択フロー
```
「行く」をタップ
    ↓
（複数ルートがある場合）
クイックリプライで選択肢表示
  [自宅→会社] [自宅→駅] [駅→会社]
    ↓
選択後、次のバス2本を表示
```

---

## 4. 技術構成（確定）

### 4.1 バックエンド
| 項目 | 技術 |
|------|------|
| 言語 | Node.js (TypeScript) |
| フレームワーク | Express.js |
| LINE SDK | @line/bot-sdk |
| データベース | PostgreSQL（Railway提供） |
| スケジューラー | node-cron（通知用） |

### 4.2 デプロイ環境
| 項目 | 選択 |
|------|------|
| サーバー | **Railway** |
| 理由 | 無料枠あり、PostgreSQL付属、スケーラブル、HTTPS標準 |
| Webhook URL | `https://xxx.up.railway.app/webhook` |

### 4.3 時刻表データ
| 項目 | 説明 |
|------|------|
| データ提供 | Excelファイルから変換済み |
| 形式 | JSON |
| 対象 | 平日ダイヤのみ（休日は将来対応予定） |

### 4.4 バス停一覧（確定）
**【行き】西条駅 → 会社**
```
西条駅 → 中央公園前 → 西条昭和町 → 石ヶ瀬橋 → 西条小学校 → 江熊 → 図書館前 → ががら口 → 東中郷 → 会社
```

**【帰り】会社 → 西条駅方面**
```
会社 → 東中郷 → ががら口 → 図書館前 → 江熊 → 西条小学校 → 石ヶ瀬橋 → 西条昭和町 → 中央公園前 → 西条駅
```
※帰りは乗り場（南門/北門）を時刻と一緒に表示
※循環便情報は非表示

### 4.5 管理者デフォルト設定
| 項目 | デフォルト値 |
|------|-------------|
| 行きの乗車バス停 | 西条駅 |
| 帰りの降車バス停 | 西条駅 |
※ユーザーが自由に変更可能

---

## 5. データ構造（確定）

### 5.1 ユーザー情報
```typescript
interface User {
  id: string;
  lineUserId: string;           // LINEユーザーID
  displayName: string;          // LINE表示名
  registrationStatus: 'pending' | 'completed';
  createdAt: Date;
  updatedAt: Date;
}
```

### 5.2 ルート情報（複数登録可能）
```typescript
interface Route {
  id: string;
  userId: string;               // ユーザーID
  name: string;                 // ルート名（例：「自宅→会社」）
  direction: 'outbound' | 'inbound';  // 行き or 帰り
  departureBusStop: string;     // 出発バス停
  arrivalBusStop: string;       // 到着バス停
  isDefault: boolean;           // デフォルトルートか
  createdAt: Date;
}
```

### 5.3 時刻表データ
```typescript
interface BusSchedule {
  id: string;
  routeId: string;              // 路線ID（システム管理）
  departureBusStop: string;     // 出発バス停名
  arrivalBusStop: string;       // 到着バス停名
  departureTime: string;        // 出発時刻 "07:00"
  dayType: 'weekday' | 'saturday' | 'sunday_holiday';
}
```

### 5.4 通知設定
```typescript
interface Notification {
  id: string;
  userId: string;
  routeId: string;              // 通知するルート
  notifyAt: Date;               // 通知時刻
  isOneTime: boolean;           // 1回限りか繰り返しか
  status: 'pending' | 'sent' | 'cancelled';
  createdAt: Date;
}
```

---

## 6. 確認事項（✅ 回答済み）

### Q1. 対象のバス路線について
- [x] 時刻表データはユーザーから提供される

### Q2. 登録する駅・バス停について
- [x] 複数ルート登録可能
- [x] 行きと帰りは別々に登録
- [x] 帰りのデフォルトは「会社」

### Q3. 表示形式について
- [x] 直近2本を表示
- [x] 所要時間は不要

### Q4. 追加機能について
- [x] リッチメニューを作成する
- [x] 通知機能あり（ユーザーが時間指定）

### Q5. デプロイ環境について
- [x] Railway を使用
- [x] LINE Developersアカウントは作成済み（予定）

---

## 7. 開発スケジュール

| フェーズ | 内容 | 期間 |
|---------|------|------|
| Phase 1 | プロジェクト初期設定・LINE Bot基盤構築 | 1日 |
| Phase 2 | データベース設計・ユーザー登録機能 | 1日 |
| Phase 3 | 時刻表データ管理・検索機能 | 1日 |
| Phase 4 | 複数ルート対応・リッチメニュー | 1日 |
| Phase 5 | 自然言語検索・通知機能 | 1日 |
| Phase 6 | テスト・デプロイ | 1日 |

---

## 8. ファイル構成（予定）

```
bus-line-bot/
├── src/
│   ├── index.ts              # エントリーポイント
│   ├── config/
│   │   └── env.ts            # 環境変数
│   ├── controllers/
│   │   ├── webhook.ts        # LINE Webhook処理
│   │   └── admin.ts          # 管理者用API
│   ├── services/
│   │   ├── line.ts           # LINE API操作
│   │   ├── user.ts           # ユーザー管理
│   │   ├── route.ts          # ルート管理
│   │   ├── schedule.ts       # 時刻表検索
│   │   ├── notification.ts   # 通知管理
│   │   └── nlp.ts            # 自然言語処理
│   ├── models/
│   │   ├── user.ts
│   │   ├── route.ts
│   │   ├── schedule.ts
│   │   └── notification.ts
│   ├── handlers/
│   │   ├── message.ts        # メッセージ処理
│   │   ├── postback.ts       # ポストバック処理
│   │   └── follow.ts         # フォロー処理
│   └── utils/
│       ├── datetime.ts       # 日時操作
│       └── messages.ts       # メッセージテンプレート
├── prisma/
│   └── schema.prisma         # DBスキーマ
├── data/
│   └── schedules.json        # 時刻表データ（初期）
├── package.json
├── tsconfig.json
├── .env.example
└── README.md
```

---

## 9. 次のステップ

要件が確定しました！以下の順序で実装を進めます：

1. **Phase 1**: プロジェクト初期設定
   - package.json, tsconfig.json 作成
   - 依存パッケージインストール
   - 基本的なExpressサーバー構築

2. **LINE Developers設定**（並行作業）
   - Messaging APIチャネル作成
   - Webhook URL設定
   - チャネルアクセストークン取得

実装を開始してよろしいですか？
